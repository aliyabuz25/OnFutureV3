events {}

http {
  # JSON access log for debugging/proof. Logs live in ./nginx-logs relative to this project.
  log_format json escape=json '{ "time":"$time_iso8601","ip":"$remote_addr","status":$status,"method":"$request_method","uri":"$request_uri","ua":"$http_user_agent" }';
  access_log  ./nginx-logs/access.log json;
  error_log   ./nginx-logs/error.log;

  # Per-IP rate limit: 20 req/s with a small burst before 503.
  limit_req_zone $binary_remote_addr zone=perip:10m rate=20r/s;

  server {
    listen 8080;
    server_name localhost;

    location / {
      limit_req zone=perip burst=40 nodelay;

      proxy_pass http://127.0.0.1:3500;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }
  }
}
